<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>VID-API ‚Äî –ö–æ–Ω–≤–µ—Ä—Ç–µ—Ä –≤–∏–¥–µ–æ –≤ ASCII</title>
  <style>
    :root {
      --color-primary: #32b8c6;
      --color-primary-hover: #2da6b3;
      --color-bg: #f5f5f2;
      --color-surface: #fff;
      --color-text: #1f2121;
      --color-text-secondary: #626c7c;
      --color-border: #e0e0de;
      --color-success: #22c55e;
      --color-error: #ef4444;
      --color-warning: #f97316;
      --radius: 8px;
      --shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: var(--color-bg);
      color: var(--color-text);
      margin: 0;
      padding: 20px;
      line-height: 1.6;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    header {
      text-align: center;
      margin-bottom: 40px;
      padding-bottom: 30px;
      border-bottom: 2px solid var(--color-border);
    }

    h1 {
      font-size: 32px;
      margin: 0 0 10px 0;
      color: var(--color-primary);
    }

    .subtitle {
      color: var(--color-text-secondary);
      font-size: 16px;
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      margin-bottom: 30px;
    }

    @media (max-width: 1024px) {
      .grid {
        grid-template-columns: 1fr;
      }
    }

    .panel {
      background: var(--color-surface);
      border-radius: var(--radius);
      padding: 24px;
      box-shadow: var(--shadow);
    }

    .panel h2 {
      margin: 0 0 20px 0;
      font-size: 20px;
      color: var(--color-text);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .form-group {
      margin-bottom: 16px;
    }

    label {
      display: block;
      font-weight: 500;
      margin-bottom: 6px;
      color: var(--color-text);
      font-size: 14px;
    }

    input[type="file"],
    input[type="number"],
    input[type="range"],
    select,
    textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--color-border);
      border-radius: var(--radius);
      font-family: inherit;
      font-size: 14px;
      color: var(--color-text);
      background: white;
      transition: border-color 0.2s;
    }

    input[type="number"]:focus,
    input[type="range"]:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: var(--color-primary);
      box-shadow: 0 0 0 3px rgba(50, 184, 198, 0.1);
    }

    input[type="range"] {
      padding: 0;
      height: 6px;
      cursor: pointer;
    }

    .range-group {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .range-group input[type="range"] {
      flex: 1;
    }

    .range-value {
      min-width: 50px;
      text-align: right;
      font-weight: 500;
      color: var(--color-primary);
    }

    .color-input-group {
      display: flex;
      gap: 8px;
    }

    input[type="color"] {
      width: 50px;
      height: 40px;
      border: 1px solid var(--color-border);
      border-radius: var(--radius);
      cursor: pointer;
    }

    .checkbox-group {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .checkbox-label {
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      margin: 0;
      font-weight: 400;
    }

    input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .button-group {
      display: flex;
      gap: 12px;
      margin-top: 24px;
    }

    button {
      flex: 1;
      padding: 12px 16px;
      border: none;
      border-radius: var(--radius);
      font-weight: 500;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
    }

    .btn-primary {
      background: var(--color-primary);
      color: white;
    }

    .btn-primary:hover {
      background: var(--color-primary-hover);
      box-shadow: 0 4px 12px rgba(50, 184, 198, 0.3);
    }

    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .btn-secondary {
      background: var(--color-border);
      color: var(--color-text);
    }

    .btn-secondary:hover {
      background: #d0d0ce;
    }

    .preview-container {
      background: #000;
      border-radius: var(--radius);
      padding: 16px;
      margin-top: 16px;
      overflow: hidden;
      min-height: 200px;
      display: flex;
      flex-direction: column;
    }

    .preview-label {
      color: #888;
      font-size: 12px;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    #asciiPreview {
      font-family: "Monaco", "Courier New", monospace;
      font-size: 9px;
      color: #00ff00;
      line-height: 1;
      white-space: pre;
      overflow-y: auto;
      flex: 1;
      background: #000;
      padding: 8px;
      border-radius: 4px;
    }

    .status-message {
      padding: 12px 16px;
      border-radius: var(--radius);
      margin-bottom: 16px;
      display: none;
    }

    .status-message.show {
      display: block;
    }

    .status-message.success {
      background: #dcfce7;
      color: #166534;
      border: 1px solid #86efac;
    }

    .status-message.error {
      background: #fee2e2;
      color: #991b1b;
      border: 1px solid #fca5a5;
    }

    .status-message.info {
      background: #e0f2fe;
      color: #164e63;
      border: 1px solid #7dd3fc;
    }

    .progress-bar {
      width: 100%;
      height: 6px;
      background: var(--color-border);
      border-radius: 3px;
      overflow: hidden;
      margin-top: 12px;
      display: none;
    }

    .progress-bar.show {
      display: block;
    }

    .progress-fill {
      height: 100%;
      background: var(--color-primary);
      width: 0%;
      transition: width 0.2s;
    }

    .result-section {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-top: 20px;
    }

    @media (max-width: 768px) {
      .result-section {
        grid-template-columns: 1fr;
      }
    }

    .result-card {
      background: var(--color-surface);
      border-radius: var(--radius);
      padding: 20px;
      box-shadow: var(--shadow);
    }

    .result-card h3 {
      margin: 0 0 12px 0;
      font-size: 16px;
      color: var(--color-text);
    }

    .result-info {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 16px;
    }

    .info-item {
      padding: 8px 12px;
      background: var(--color-bg);
      border-radius: 4px;
      font-size: 13px;
    }

    .info-item strong {
      display: block;
      color: var(--color-text-secondary);
      font-weight: 600;
      margin-bottom: 2px;
    }

    .info-value {
      color: var(--color-primary);
      font-weight: 500;
    }

    .file-selector {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 20px;
      border: 2px dashed var(--color-border);
      border-radius: var(--radius);
      cursor: pointer;
      transition: all 0.2s;
      background: var(--color-bg);
    }

    .file-selector:hover {
      border-color: var(--color-primary);
      background: rgba(50, 184, 198, 0.05);
    }

    .file-selector.dragover {
      border-color: var(--color-primary);
      background: rgba(50, 184, 198, 0.1);
    }

    .file-selector input {
      display: none;
    }

    .file-selector-text {
      flex: 1;
    }

    .file-selector-text .label {
      display: block;
      font-weight: 500;
      color: var(--color-text);
      margin-bottom: 4px;
    }

    .file-selector-text .hint {
      font-size: 13px;
      color: var(--color-text-secondary);
    }

    .file-info {
      padding: 12px 16px;
      background: var(--color-bg);
      border-radius: var(--radius);
      display: none;
      margin-top: 12px;
    }

    .file-info.show {
      display: block;
    }

    .file-info .file-name {
      font-weight: 500;
      color: var(--color-text);
      margin-bottom: 4px;
    }

    .file-info .file-size {
      font-size: 13px;
      color: var(--color-text-secondary);
    }

    .download-button {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      background: var(--color-primary);
      color: white;
      border: none;
      border-radius: var(--radius);
      cursor: pointer;
      font-weight: 500;
      font-size: 14px;
      transition: background 0.2s;
    }

    .download-button:hover {
      background: var(--color-primary-hover);
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      margin-bottom: 20px;
    }

    @media (max-width: 768px) {
      .stats {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    .stat {
      padding: 12px;
      background: var(--color-bg);
      border-radius: var(--radius);
      text-align: center;
    }

    .stat-value {
      font-size: 24px;
      font-weight: bold;
      color: var(--color-primary);
    }

    .stat-label {
      font-size: 12px;
      color: var(--color-text-secondary);
      margin-top: 4px;
    }

    .loading-spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .emoji {
      display: inline-block;
      margin-right: 4px;
    }

    footer {
      text-align: center;
      margin-top: 60px;
      padding-top: 30px;
      border-top: 1px solid var(--color-border);
      color: var(--color-text-secondary);
      font-size: 13px;
    }

    footer a {
      color: var(--color-primary);
      text-decoration: none;
    }

    footer a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üé¨ VID-API</h1>
      <p class="subtitle">–ö–æ–Ω–≤–µ—Ä—Ç–µ—Ä –≤–∏–¥–µ–æ –≤ ASCII-–∞—Ä—Ç —Å –∂–∏–≤—ã–º –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–æ–º</p>
    </header>

    <div id="statusMessage" class="status-message"></div>

    <div class="grid">
      <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –ù–∞—Å—Ç—Ä–æ–π–∫–∏ -->
      <div class="panel">
        <h2><span class="emoji">‚öôÔ∏è</span>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏</h2>

        <!-- –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ -->
        <div class="form-group">
          <label for="fileInput">–í–∏–¥–µ–æ —Ñ–∞–π–ª</label>
          <div class="file-selector" id="fileSelector">
            <div class="file-selector-text">
              <span class="label">–í—ã–±–µ—Ä–∏ –≤–∏–¥–µ–æ</span>
              <span class="hint">–∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏ MP4/AVI/MOV</span>
            </div>
            <input type="file" id="fileInput" accept="video/*" />
          </div>
          <div id="fileInfo" class="file-info">
            <div class="file-name"></div>
            <div class="file-size"></div>
          </div>
        </div>

        <!-- –®–∏—Ä–∏–Ω–∞ ASCII -->
        <div class="form-group">
          <label for="widthInput">–®–∏—Ä–∏–Ω–∞ (—Å–∏–º–≤–æ–ª–æ–≤)</label>
          <div class="range-group">
            <input
              type="range"
              id="widthInput"
              min="40"
              max="200"
              value="120"
              step="10"
            />
            <span class="range-value" id="widthValue">120</span>
          </div>
        </div>

        <!-- –°—Ç–∏–ª—å ASCII -->
        <div class="form-group">
          <label for="styleInput">–°—Ç–∏–ª—å ASCII</label>
          <select id="styleInput">
            <option value="normal">üìä Normal (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π)</option>
            <option value="inverted">üîô Inverted (–∏–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π)</option>
            <option value="dots">üîò Dots (—Ç–æ—á–∫–∏)</option>
            <option value="gradient">üåà Gradient (–≥—Ä–∞–¥–∏–µ–Ω—Ç)</option>
            <option value="blocks">‚¨õ Blocks (–±–ª–æ–∫–∏)</option>
          </select>
        </div>

        <!-- –Ø—Ä–∫–æ—Å—Ç—å -->
        <div class="form-group">
          <label for="brightnessInput">–Ø—Ä–∫–æ—Å—Ç—å</label>
          <div class="range-group">
            <input
              type="range"
              id="brightnessInput"
              min="0.3"
              max="2"
              value="1"
              step="0.1"
            />
            <span class="range-value" id="brightnessValue">1.0</span>
          </div>
        </div>

        <!-- –ö–æ–Ω—Ç—Ä–∞—Å—Ç -->
        <div class="form-group">
          <label for="contrastInput">–ö–æ–Ω—Ç—Ä–∞—Å—Ç</label>
          <div class="range-group">
            <input
              type="range"
              id="contrastInput"
              min="0.3"
              max="2"
              value="1"
              step="0.1"
            />
            <span class="range-value" id="contrastValue">1.0</span>
          </div>
        </div>

        <!-- –ì–∞–º–º–∞-–∫–æ—Ä—Ä–µ–∫—Ü–∏—è -->
        <div class="form-group">
          <label for="gammaInput">–ì–∞–º–º–∞-–∫–æ—Ä—Ä–µ–∫—Ü–∏—è</label>
          <div class="range-group">
            <input
              type="range"
              id="gammaInput"
              min="0.5"
              max="2"
              value="1"
              step="0.1"
            />
            <span class="range-value" id="gammaValue">1.0</span>
          </div>
        </div>

        <!-- –¶–≤–µ—Ç–∞ -->
        <div class="form-group">
          <label>–¶–≤–µ—Ç–∞</label>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            <div>
              <label style="margin-bottom: 4px; font-size: 12px;">–§–æ–Ω</label>
              <div class="color-input-group">
                <input type="color" id="bgColorInput" value="#000000" />
                <input
                  type="text"
                  id="bgColorText"
                  value="#000000"
                  maxlength="7"
                  style="flex: 1;"
                />
              </div>
            </div>
            <div>
              <label style="margin-bottom: 4px; font-size: 12px;">–¢–µ–∫—Å—Ç</label>
              <div class="color-input-group">
                <input type="color" id="textColorInput" value="#00ff00" />
                <input
                  type="text"
                  id="textColorText"
                  value="#00ff00"
                  maxlength="7"
                  style="flex: 1;"
                />
              </div>
            </div>
          </div>
        </div>

        <!-- –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –æ–ø—Ü–∏–∏ -->
        <div class="form-group">
          <label>–û–ø—Ü–∏–∏</label>
          <div class="checkbox-group">
            <label class="checkbox-label">
              <input type="checkbox" id="randomColorsInput" />
              –°–ª—É—á–∞–π–Ω—ã–µ —Ü–≤–µ—Ç–∞
            </label>
            <label class="checkbox-label">
              <input type="checkbox" id="transparentBgInput" />
              –ü—Ä–æ–∑—Ä–∞—á–Ω—ã–π —Ñ–æ–Ω
            </label>
          </div>
        </div>

        <!-- –í–∏–¥–µ–æ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
          <div class="form-group">
            <label for="fpsInput">FPS –≤–∏–¥–µ–æ</label>
            <input type="number" id="fpsInput" value="30" min="1" max="60" />
          </div>
          <div class="form-group">
            <label for="crfInput">–ö–∞—á–µ—Å—Ç–≤–æ (CRF)</label>
            <input type="number" id="crfInput" value="23" min="0" max="51" />
          </div>
        </div>

        <!-- –ö–Ω–æ–ø–∫–∏ -->
        <div class="button-group">
          <button class="btn-primary" id="convertBtn">
            <span class="emoji">üöÄ</span>–ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å
          </button>
          <button class="btn-secondary" id="clearBtn">
            <span class="emoji">üóëÔ∏è</span>–û—á–∏—Å—Ç–∏—Ç—å
          </button>
        </div>

        <div id="progressBar" class="progress-bar">
          <div class="progress-fill"></div>
        </div>
      </div>

      <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä -->
      <div class="panel">
        <h2><span class="emoji">üëÅÔ∏è</span>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä ASCII</h2>
        <p style="font-size: 13px; color: var(--color-text-secondary); margin: 0 0 12px 0;">
          –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
        </p>
        <div class="preview-container">
          <div class="preview-label">–ü–µ—Ä–≤—ã–π –∫–∞–¥—Ä</div>
          <div id="asciiPreview">
            <div style="text-align: center; padding: 20px; color: #888;">
              –ó–∞–≥—Ä—É–∑–∏ –≤–∏–¥–µ–æ —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
    <div id="resultsContainer" style="display: none;">
      <div class="panel">
        <h2><span class="emoji">‚úÖ</span>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏</h2>

        <div class="stats" id="statsContainer"></div>

        <div class="result-section" id="resultSection"></div>
      </div>
    </div>
  </div>

  <footer>
    <p>
      VID-API ‚Äî OpenSource –∫–æ–Ω–≤–µ—Ä—Ç–µ—Ä –≤–∏–¥–µ–æ –≤ ASCII-–∞—Ä—Ç |
      <a href="https://github.com/Timoxa760/vid-api" target="_blank">GitHub</a>
    </p>
  </footer>

  <script>
    const API_URL = "http://localhost:8000/api/v1";

    // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
    const fileInput = document.getElementById("fileInput");
    const fileSelector = document.getElementById("fileSelector");
    const fileInfo = document.getElementById("fileInfo");
    const widthInput = document.getElementById("widthInput");
    const widthValue = document.getElementById("widthValue");
    const styleInput = document.getElementById("styleInput");
    const brightnessInput = document.getElementById("brightnessInput");
    const brightnessValue = document.getElementById("brightnessValue");
    const contrastInput = document.getElementById("contrastInput");
    const contrastValue = document.getElementById("contrastValue");
    const gammaInput = document.getElementById("gammaInput");
    const gammaValue = document.getElementById("gammaValue");
    const bgColorInput = document.getElementById("bgColorInput");
    const bgColorText = document.getElementById("bgColorText");
    const textColorInput = document.getElementById("textColorInput");
    const textColorText = document.getElementById("textColorText");
    const fpsInput = document.getElementById("fpsInput");
    const crfInput = document.getElementById("crfInput");
    const convertBtn = document.getElementById("convertBtn");
    const clearBtn = document.getElementById("clearBtn");
    const statusMessage = document.getElementById("statusMessage");
    const progressBar = document.getElementById("progressBar");
    const progressFill = progressBar.querySelector(".progress-fill");
    const asciiPreview = document.getElementById("asciiPreview");
    const resultsContainer = document.getElementById("resultsContainer");

    let currentFile = null;
    let previewFrame = null;
    let currentJobId = null;

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∑–Ω–∞—á–µ–Ω–∏–π
    widthInput.addEventListener("input", () => {
      widthValue.textContent = widthInput.value;
      updatePreview();
    });

    brightnessInput.addEventListener("input", () => {
      brightnessValue.textContent = parseFloat(brightnessInput.value).toFixed(1);
      updatePreview();
    });

    contrastInput.addEventListener("input", () => {
      contrastValue.textContent = parseFloat(contrastInput.value).toFixed(1);
      updatePreview();
    });

    gammaInput.addEventListener("input", () => {
      gammaValue.textContent = parseFloat(gammaInput.value).toFixed(1);
      updatePreview();
    });

    styleInput.addEventListener("change", updatePreview);

    // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ü–≤–µ—Ç–æ–≤
    bgColorInput.addEventListener("input", (e) => {
      bgColorText.value = e.target.value;
      updatePreview();
    });

    bgColorText.addEventListener("input", (e) => {
      if (/^#[0-9A-F]{6}$/i.test(e.target.value)) {
        bgColorInput.value = e.target.value;
        updatePreview();
      }
    });

    textColorInput.addEventListener("input", (e) => {
      textColorText.value = e.target.value;
      updatePreview();
    });

    textColorText.addEventListener("input", (e) => {
      if (/^#[0-9A-F]{6}$/i.test(e.target.value)) {
        textColorInput.value = e.target.value;
        updatePreview();
      }
    });

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞
    fileSelector.addEventListener("click", () => fileInput.click());

    fileInput.addEventListener("change", (e) => {
      handleFileSelect(e.target.files[0]);
    });

    // Drag & Drop
    fileSelector.addEventListener("dragover", (e) => {
      e.preventDefault();
      fileSelector.classList.add("dragover");
    });

    fileSelector.addEventListener("dragleave", () => {
      fileSelector.classList.remove("dragover");
    });

    fileSelector.addEventListener("drop", (e) => {
      e.preventDefault();
      fileSelector.classList.remove("dragover");
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        handleFileSelect(files[0]);
      }
    });

    function handleFileSelect(file) {
      if (!file) return;

      if (!file.type.startsWith("video/")) {
        showStatus("–í—ã–±–µ—Ä–∏ –≤–∏–¥–µ–æ —Ñ–∞–π–ª", "error");
        return;
      }

      const maxSize = 500 * 1024 * 1024; // 500 MB
      if (file.size > maxSize) {
        showStatus("–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å 500 MB)", "error");
        return;
      }

      currentFile = file;
      updateFileInfo();
      extractFirstFrame();
    }

    function updateFileInfo() {
      if (!currentFile) {
        fileInfo.classList.remove("show");
        return;
      }

      const sizeMB = (currentFile.size / 1024 / 1024).toFixed(2);
      fileInfo.querySelector(".file-name").textContent = currentFile.name;
      fileInfo.querySelector(".file-size").textContent = `${sizeMB} MB`;
      fileInfo.classList.add("show");
    }

    // –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –ø–µ—Ä–≤–æ–≥–æ –∫–∞–¥—Ä–∞ –∏–∑ –≤–∏–¥–µ–æ
    function extractFirstFrame() {
      const video = document.createElement("video");
      const reader = new FileReader();

      reader.onload = (e) => {
        video.src = e.target.result;
        video.currentTime = 0;

        video.onloadedmetadata = () => {
          video.currentTime = 0;
        };

        video.onseeked = () => {
          const canvas = document.createElement("canvas");
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          const ctx = canvas.getContext("2d");
          ctx.drawImage(video, 0, 0);
          previewFrame = canvas;
          updatePreview();
        };
      };

      reader.readAsArrayBuffer(currentFile);
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ ASCII
    function updatePreview() {
      if (!previewFrame) {
        asciiPreview.innerHTML =
          '<div style="text-align: center; padding: 20px; color: #888;">–ó–∞–≥—Ä—É–∑–∏ –≤–∏–¥–µ–æ —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</div>';
        return;
      }

      try {
        const canvas = previewFrame;
        const ctx = canvas.getContext("2d");
        const imageData = ctx.getImageData(
          0,
          0,
          canvas.width,
          canvas.height
        );
        const data = imageData.data;

        const width = parseInt(widthInput.value);
        const height = Math.ceil((width * canvas.height) / canvas.width * 0.55);

        // –†–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π ASCII —Å–µ—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ç–∏–ª—è
        const styles = {
          normal:
            " .:-=+*#%@",
          inverted:
            "@%#*+=-:. ",
          dots:
            "¬∑‚Ä¢‚ó¶‚óã‚óâ",
          gradient:
            " ‚ñë‚ñí‚ñì‚ñà",
          blocks:
            " ‚ññ‚ñó‚ñò‚ñô‚ñö‚ñù‚ñû‚ñü"
        };

        const asciiSet = styles[styleInput.value] || styles.normal;

        // –°–æ–∑–¥–∞–Ω–∏–µ —É–º–µ–Ω—å—à–µ–Ω–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        const resizeCanvas = document.createElement("canvas");
        resizeCanvas.width = width;
        resizeCanvas.height = height;
        const resizeCtx = resizeCanvas.getContext("2d");
        resizeCtx.drawImage(canvas, 0, 0, width, height);

        const resizedData = resizeCtx.getImageData(0, 0, width, height).data;

        // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
        const brightness = parseFloat(brightnessInput.value);
        const contrast = parseFloat(contrastInput.value);
        const gamma = parseFloat(gammaInput.value);

        let ascii = "";
        for (let i = 0; i < resizedData.length; i += 4) {
          const r = resizedData[i];
          const g = resizedData[i + 1];
          const b = resizedData[i + 2];

          // –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤ grayscale
          let gray = 0.299 * r + 0.587 * g + 0.114 * b;

          // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —è—Ä–∫–æ—Å—Ç–∏
          gray *= brightness;

          // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ç—Ä–∞—Å—Ç–∞
          const mean = 128;
          gray = (gray - mean) * contrast + mean;

          // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –≥–∞–º–º—ã
          gray = Math.pow(gray / 255, 1 / gamma) * 255;

          // –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è
          gray = Math.max(0, Math.min(255, gray));

          const normalized = gray / 255;
          const idx = Math.floor(normalized * (asciiSet.length - 1));
          ascii += asciiSet[idx];

          if ((i / 4 + 1) % width === 0) {
            ascii += "\n";
          }
        }

        // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∏–ª—è –∫ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä—É
        asciiPreview.textContent = ascii;
        asciiPreview.style.color = textColorInput.value;
        asciiPreview.style.backgroundColor = bgColorInput.value;
      } catch (e) {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞:", e);
      }
    }

    // –ü–æ–∫–∞–∑ —Å—Ç–∞—Ç—É—Å–∞
    function showStatus(message, type = "info") {
      statusMessage.textContent = message;
      statusMessage.className = `status-message show ${type}`;
      setTimeout(() => {
        statusMessage.classList.remove("show");
      }, 5000);
    }

    // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–∏–¥–µ–æ
    convertBtn.addEventListener("click", async () => {
      if (!currentFile) {
        showStatus("–í—ã–±–µ—Ä–∏ –≤–∏–¥–µ–æ —Ñ–∞–π–ª", "error");
        return;
      }

      const formData = new FormData();
      formData.append("file", currentFile);
      formData.append("width", widthInput.value);
      formData.append("style", styleInput.value);
      formData.append("brightness", brightnessInput.value);
      formData.append("contrast", contrastInput.value);
      formData.append("gamma", gammaInput.value);
      formData.append("random_colors", document.getElementById("randomColorsInput").checked);
      formData.append("transparent_bg", document.getElementById("transparentBgInput").checked);
      formData.append("bg_color", bgColorInput.value);
      formData.append("text_color", textColorInput.value);
      formData.append("fps", fpsInput.value);
      formData.append("crf", crfInput.value);

      convertBtn.disabled = true;
      convertBtn.innerHTML =
        '<span class="loading-spinner"></span> –û–±—Ä–∞–±–æ—Ç–∫–∞...';
      progressBar.classList.add("show");
      progressFill.style.width = "0%";

      showStatus("–û—Ç–ø—Ä–∞–≤–ª—è—é –≤–∏–¥–µ–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä...", "info");

      try {
        const response = await fetch(`${API_URL}/convert/video`, {
          method: "POST",
          body: formData,
        });

        if (!response.ok) {
          const errorData = await response.json();
          showStatus(
            `–û—à–∏–±–∫–∞: ${errorData.detail || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞"}`,
            "error"
          );
          progressBar.classList.remove("show");
          convertBtn.disabled = false;
          convertBtn.innerHTML = "<span class='emoji'>üöÄ</span>–ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å";
          return;
        }

        const data = await response.json();
        currentJobId = data.job_id;

        showStatus(
          `–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞! Job ID: ${data.job_id}`,
          "success"
        );
        progressFill.style.width = "100%";

        displayResults(data);
      } catch (e) {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:", e);
        showStatus(`–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞: ${e.message}`, "error");
      } finally {
        convertBtn.disabled = false;
        convertBtn.innerHTML = "<span class='emoji'>üöÄ</span>–ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å";
        setTimeout(() => {
          progressBar.classList.remove("show");
        }, 1000);
      }
    });

    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    function displayResults(data) {
      resultsContainer.style.display = "block";
      resultsContainer.scrollIntoView({ behavior: "smooth", block: "nearest" });

      const stats = [
        {
          label: "–ö–∞–¥—Ä–æ–≤",
          value: data.result.frames_count || "‚Äî",
        },
        {
          label: "FPS",
          value: data.result.fps || "‚Äî",
        },
        {
          label: "PNG",
          value: data.result.png_files_count || 0,
        },
        {
          label: "–í—Ä–µ–º—è",
          value: `${data.processing_time_seconds.toFixed(2)}s`,
        },
      ];

      const statsHtml = stats
        .map(
          (s) => `
        <div class="stat">
          <div class="stat-value">${s.value}</div>
          <div class="stat-label">${s.label}</div>
        </div>
      `
        )
        .join("");

      document.getElementById("statsContainer").innerHTML = statsHtml;

      let resultHtml = "";

      if (data.result.mp4_url) {
        resultHtml += `
          <div class="result-card">
            <h3><span class="emoji">üé•</span>–í–∏–¥–µ–æ MP4</h3>
            <div class="result-info">
              <div class="info-item">
                <strong>–°—Ç–∞—Ç—É—Å</strong>
                <span class="info-value">‚úÖ –ì–æ—Ç–æ–≤–æ</span>
              </div>
              <div class="info-item">
                <strong>–†–∞–∑–º–µ—Ä</strong>
                <span class="info-value">–í—ã—á–∏—Å–ª—è–µ—Ç—Å—è...</span>
              </div>
            </div>
            <a href="${API_URL}/download/${data.job_id}/video" class="download-button">
              <span class="emoji">‚¨áÔ∏è</span>–°–∫–∞—á–∞—Ç—å MP4
            </a>
          </div>
        `;
      }

      resultHtml += `
        <div class="result-card">
          <h3><span class="emoji">üìä</span>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
          <div class="result-info">
            <div class="info-item">
              <strong>Job ID</strong>
              <span class="info-value" style="font-family: monospace; font-size: 12px;">${data.job_id}</span>
            </div>
            <div class="info-item">
              <strong>–°—Ç–∞—Ç—É—Å</strong>
              <span class="info-value">${data.status}</span>
            </div>
            <div class="info-item">
              <strong>–°–æ–∑–¥–∞–Ω–∞</strong>
              <span class="info-value">${new Date(data.created_at).toLocaleTimeString()}</span>
            </div>
            <div class="info-item">
              <strong>–ó–∞–≤–µ—Ä—à–µ–Ω–∞</strong>
              <span class="info-value">${new Date(data.completed_at).toLocaleTimeString()}</span>
            </div>
          </div>
        </div>
      `;

      document.getElementById("resultSection").innerHTML = resultHtml;
    }

    // –û—á–∏—Å—Ç–∫–∞
    clearBtn.addEventListener("click", () => {
      currentFile = null;
      previewFrame = null;
      fileInput.value = "";
      fileInfo.classList.remove("show");
      asciiPreview.innerHTML =
        '<div style="text-align: center; padding: 20px; color: #888;">–ó–∞–≥—Ä—É–∑–∏ –≤–∏–¥–µ–æ —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</div>';
      resultsContainer.style.display = "none";
      statusMessage.classList.remove("show");
      progressBar.classList.remove("show");
    });
  </script>
</body>
</html>
